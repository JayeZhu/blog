---
title: 手写Promise
date: 2021-04-27 15:16:15
permalink: /pages/58f7fd/
categories:
  - 前端
tags:
  - JavaScript
  - 手写API
---
```js
const PENDING = 'pending'
const FULFILLED = 'fulfilled';
const REJECTED = 'rejected';

function Promise (fn) {
  // 保存 this 值
  let self = this;

  // 初始化状态为 PENDING
  this.state = PENDING;

  // 初始化通过 resolve 或 reject 传入的值
  this.value = null;

  // 保存 resolve 和 reject 回调函数
  this.resolvedCallbacks = [];
  this.rejectedCallbacks = [];

  // 声明 resolve 方法
  function resolve (value) {
    // 首先判断传入的是不是 Promise 值，如果是，就需要等待传入 Promise 值状态改变后再进行改变
    if (value instanceof Promise) {
      return value.then(resolve, reject);
    }

    // 然后使用定时器是通过宏任务保证执行顺序为本轮事件循环的末尾
    setTimeout(() => {
      // 接着需要保证状态值为 PENDING 才能转变
      if (self.state === PENDING) {
        设置状态和传入值
        self.state = FULFILLED；
        self.value = value;
      }
    })
  }
}
```