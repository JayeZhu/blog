---
title: 变量对象
date: 2021-03-26 15:17:46
permalink: /fe/16829a/
categories:
  - 前端
tags:
  - JavaScript
  - 调用堆栈
---
## 定义
变量对象（Variable Object，VO）是执行上下文重要组成部分——数据作用域，存储了在执行上下文中定义的所有变量声明和函数声明，保证代码执行时对变量和函数的正确访问。

## 种类
通过不同执行上下文，可以简单分为：
- 全局执行上下文对应的全局执行上下文变量对象，其实就是全局对象
- 函数执行上下文对应的函数执行上下文变量对象，其实就是活动对象

### 全局对象
其中全局执行上下文变量对象其实就是全局对象，我们简单看下全局对象
> 全局对象是预定义的对象，作为 JavaScript 的全局函数和全局属性的占位符，通过全局对象，可以访问所有其他预定义的对象、函数和属性。全局对象不是任何对象的属性，所以它没有名称

在浏览器中，全局对象是 window 对象；在 Node 中，是 global 对象。前端开发中主要用的是 window 对象，
一些全局属性比如，变量 path、screen，方法 parseInt()、postMessage() 等。

简单总结一下全局对象的特点：
- 全局对象在执行所有代码前被创建
- 全局对象一致存在，直到程序结束
- 全局对象保存了全局上下文中所有的变量和函数声明
- 全局变量对象位于作用域链的顶端

### 活动对象
在进入函数执行上下文中，函数执行上下文对应的变量对象激活，变成活动对象(Activeion Object,AO)。但其实活动对象和变量对象是同一种东西，只不过变量对象在激活前，不可再 JavaScript 环境中访问，而被激活的活动对象中的各种属性才可以访问。

活动对象是在进入函数上下文时被创建的，它通过函数的 arguments 属性初始化，这个属性的属性值是 Arguments 对象，包括如下属性：
- callee：指向当前函数的引用
- length：真正传递的参数个数
- indexes-properties：索引值和属性值的类数组列表

## 两个阶段
可执行代码分为解析和执行两个阶段，对应的变量对象的创建和赋值两阶段。

### 创建阶段
在代码解析阶段，会根据执行上下文中的变量声明和函数声明来创建变量对象，这时的变量对项被 arguments 属性初始化，内容包括：
- 变量声明
  - 通过 var 声明的变量
  - 由名称和对应值 (undefined) 组成，作为变量对象的属性被创建
  - 如果变量名称跟已经声明的形参或函数相同，则变量声明**不会干扰**已经存在的这类属性
- 函数声明
  - 有名称和对应值 (函数对象(function-object)，指向堆函数的引用)组成，作为变量对象的属性被创建
  - 如果变量对象存在相同名称的属性，则完全**替换**这个属性
- 函数的所有形参
  - 存在于函数执行上下文
  - 有名称和对应值组成，作为变量对象的属性被创建
  - 没有实参，属性值设为 undefined
来一个例子看一下：
```javascript
function foo (a) {
  var a = 2;
  var b = 3;
  function c () {};
  var d = function () {};
}

foo(1)
```
foo(1)执行前会创建函数执行上下文，其中包括函数执行上下文的变量对象VO，激活后成为活动对象 AO，呈现如下
```javascript
AO = {
  arguments: {
    0: 1,
    length: 1
  },
  a: 1,
  b: undefined,
  c: reference to function c () {},
  d: undefined
}
```
有几个注意的点：
- 声明的 a 不影响形参 a，值是 1
- 声明的 b 默认值是 undefined
- c 和 d 虽然都是函数，但声明方式不一样：
  - c 是声明的函数，值是函数声明及指向
  - d 是声明的变量，然后赋值了方法，所以还是变量，值为 undefined

### 赋值阶段
在代码执行阶段，ui顺序指向代码，根据代码，修改变量对象的值。

上面的 AO 会变为：
```javascript
AO = {
  arguments: {
    0: 1,
    length: 1
  },
  a: 2,
  b: 3,
  c: refrence to function c () {},
  d: refrence to FunctionExpression "d"
}
```

## 参考文章
- [JavaScript深入之变量对象](https://github.com/mqyqingfeng/Blog/issues/5)