---
title: Next部署后数据库无法访问
date: 2025-10-28 02:30:00
permalink: /pages/353ddc/
categories:
  - 后端
tags:
  - Next
  - Next部署
---
## 背景
在 vercel 上部署 Next.js 项目，数据库无法访问，报错如下：

```bash
Error getting chats: Error: Failed query: select "id", "user_id", "title", "model", "pinned", "timestamp" from "chats" where "chats"."user_id" = $1 order by "chats"."id" desc
params: user_34VBVdC2jmBBVuPLucijYsUl9Dg
    at s4.queryWithCache (.next/server/chunks/[root-of-the-server]__0b647be8._.js:28:36980)
    at async (.next/server/chunks/[root-of-the-server]__0b647be8._.js:28:39389)
    at async d (.next/server/chunks/[root-of-the-server]__9f6209dc._.js:1:11126)
    at async v (.next/server/chunks/[root-of-the-server]__9f6209dc._.js:1:12522)
    at async p (.next/server/chunks/[root-of-the-server]__9f6209dc._.js:1:15649)
    at async l (.next/server/chunks/[root-of-the-server]__9f6209dc._.js:1:16687) {
  query: 'select "id", "user_id", "title", "model", "pinned", "timestamp" from "chats" where "chats"."user_id" = $1 order by "chats"."id" desc',
  params: [Array],
  [cause]: Error: getaddrinfo ENOTFOUND db.atoyzkuffuajlvsrofzdx.supabase.co
      at ignore-listed frames {
    errno: -3007,
    code: 'ENOTFOUND',
    syscall: 'getaddrinfo',
    hostname: 'db.atoyzkuffuajlvsrofzdx.supabase.co'
  }
}
```
本地是正常的，部署后就报错。

## 连接方式
数据库是在 `supabase` 上创建的，使用 drizzle 连接，代码如下：
```ts
import { drizzle } from 'drizzle-orm/postgres-js'
import postgres from 'postgres'

const client = postgres(process.env.DATABASE_URL!)
const db = drizzle({ client });
```

## Vercel 配置环境变量
在 vercel 项目中的 Environment Variables 中配置了 `DATABASE_URL`

## 解决方案
找了很多办法，如
- 使用 IP地址连接
- 使用Google DNS
- 用anon key连接

但是都没有用，结果在 supabase 的 Connect 设置中发现了问题，它的 IPv4 是不支持的。这里分析一下：
- vercel 免费的用的 IPv4
- supabase 免费的用的 IPv6

我只需要充值其中一个就可以解决问题，但是，肯定还有其他办法，就是：

将连接方式改为 transaction pooler 方式，supabase 连接凡是就会改为 ipv4。在 supabase 更改完成后，去 vercel 更改一下重新获取的 DATABASE_URL，重新部署，终于获取到了数据。真的功夫不负有心人！