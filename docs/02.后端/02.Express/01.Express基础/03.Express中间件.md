---
title: Express中间件
date: 2025-10-15 15:31:22
permalink: /pages/15306b/
categories:
  - 后端
tags:
  - Express
  - Express基础
---
## 中间件概念

中间件是 Express 的核心概念，它是一个函数，可以访问请求对象(req)、响应对象(res)和应用程序的请求-响应循环中的下一个中间件函数。下一个中间件函数通常由一个名为 `next` 的变量来表示。

```javascript
// 基本中间件结构
function middleware(req, res, next) {
  // 执行一些代码
  console.log('中间件执行');
  
  // 调用下一个中间件
  next();
}
```

## 编写自定义中间件

### 1. 应用级中间件

```javascript
// 简单的日志中间件
const logger = (req, res, next) => {
  console.log(`${new Date().toISOString()} - ${req.method} ${req.url}`);
  next();
};

// 应用中间件
app.use(logger);
```

### 2. 路由级中间件

```javascript
// 特定路由的中间件
const checkAuth = (req, res, next) => {
  if (req.session.user) {
    next();
  } else {
    res.status(401).send('未授权访问');
  }
};

// 应用到特定路由
app.get('/admin', checkAuth, (req, res) => {
  res.send('管理员页面');
});
```

### 3. 错误处理中间件

```javascript
// 错误处理中间件
const errorHandler = (err, req, res, next) => {
  console.error(err.stack);
  res.status(500).send('服务器错误');
};

// 必须放在最后
app.use(errorHandler);
```

## 常用第三方中间件

### 1. body-parser

用于解析请求体，虽然 Express 4.16+ 已内置部分功能，但某些复杂场景仍需使用。

```javascript
const bodyParser = require('body-parser');

// 解析 JSON
app.use(bodyParser.json());

// 解析 URL 编码的请求体
app.use(bodyParser.urlencoded({ extended: true }));
```

### 2. morgan

HTTP 请求日志中间件，用于记录请求日志。

```javascript
const morgan = require('morgan');

// 使用预定义格式
app.use(morgan('combined'));

// 自定义格式
app.use(morgan(':method :url :status :res[content-length] - :response-time ms'));
```

### 3. cors

处理跨域资源共享(CORS)的中间件。

```javascript
const cors = require('cors');

// 启用所有 CORS 请求
app.use(cors());

// 配置特定选项
app.use(cors({
  origin: 'http://example.com',
  methods: ['GET', 'POST'],
  allowedHeaders: ['Content-Type', 'Authorization']
}));
```

### 4. helmet

通过设置各种 HTTP 头来帮助保护应用免受一些众所周知的 Web 漏洞的影响。

```javascript
const helmet = require('helmet');

// 使用所有默认中间件
app.use(helmet());

// 自定义配置
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      scriptSrc: ["'self'"],
      imgSrc: ["'self'", "data:", "https:"]
    }
  }
}));
```

### 5. cookie-parser

解析 Cookie 的中间件。

```javascript
const cookieParser = require('cookie-parser');

// 使用中间件
app.use(cookieParser());

// 在路由中使用
app.get('/', (req, res) => {
  console.log('Cookies: ', req.cookies);
  res.send('Hello World');
});
```

### 6. express-session

会话管理中间件。

```javascript
const session = require('express-session');

app.use(session({
  secret: 'your-secret-key',
  resave: false,
  saveUninitialized: true,
  cookie: { 
    secure: false, // 生产环境应设为 true
    maxAge: 60000  // 1分钟
  }
}));

// 在路由中使用
app.get('/', (req, res) => {
  if (req.session.views) {
    req.session.views++;
  } else {
    req.session.views = 1;
  }
  res.send(`访问次数: ${req.session.views}`);
});
```

## 实践案例

### 博客系统中的中间件应用

```javascript
// 1. 认证中间件
const authenticate = (req, res, next) => {
  if (req.session.userId) {
    next();
  } else {
    res.redirect('/login');
  }
};

// 2. 博客文章访问日志中间件
const blogLogger = (req, res, next) => {
  console.log(`访问文章: ${req.params.id} - ${new Date()}`);
  next();
};

// 3. 错误处理中间件
const blogErrorHandler = (err, req, res, next) => {
  console.error(err.stack);
  if (req.xhr) {
    res.status(500).json({ error: '服务器错误' });
  } else {
    res.status(500).render('error', { error: '服务器错误' });
  }
};

// 应用中间件
app.use(morgan('combined'));
app.use(bodyParser.json());
app.use(cookieParser());
app.use(session({ secret: 'blog-secret' }));

// 路由中使用中间件
app.get('/admin', authenticate, (req, res) => {
  res.render('admin');
});

app.get('/posts/:id', blogLogger, (req, res) => {
  res.render('post', { id: req.params.id });
});

// 错误处理
app.use(blogErrorHandler);
```

## 总结

Express 中间件系统提供了强大的请求处理能力，通过合理组合内置中间件、自定义中间件和第三方中间件，可以构建出功能丰富、安全可靠的 Web 应用。在实际开发中，应根据项目需求选择合适的中间件组合，并注意中间件的执行顺序，以确保应用的安全性和性能。