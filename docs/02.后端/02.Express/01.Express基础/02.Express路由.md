---
title: Express路由
date: 2025-10-15 15:28:45
permalink: /pages/3e259a/
categories:
  - 后端
tags:
  - Express
  - Express基础
---
## 路由基础

### 定义路由

路由是指确定应用程序如何响应对特定端点的客户端请求，该请求是特定URI（或路径）和特定HTTP请求方法（GET、POST等）的。

```javascript
const express = require('express');
const app = express();

// 基本路由定义
app.get('/', (req, res) => {
  res.send('首页');
});

app.post('/users', (req, res) => {
  res.send('创建用户');
});

app.put('/users/:id', (req, res) => {
  res.send(`更新用户ID: ${req.params.id}`);
});

app.delete('/users/:id', (req, res) => {
  res.send(`删除用户ID: ${req.params.id}`);
});

app.listen(3000, () => {
  console.log('服务器运行在端口 3000');
});
```

### 路径参数

路径参数用于捕获URL中特定位置的值，这些值会被设置在`req.params`对象中。

```javascript
// 单个路径参数
app.get('/users/:userId', (req, res) => {
  res.send(`用户ID: ${req.params.userId}`);
});

// 多个路径参数
app.get('/users/:userId/posts/:postId', (req, res) => {
  res.send(`用户 ${req.params.userId} 的文章 ${req.params.postId}`);
});

// 可选路径参数（使用问号）
app.get('/users/:userId?', (req, res) => {
  if (req.params.userId) {
    res.send(`用户ID: ${req.params.userId}`);
  } else {
    res.send('所有用户');
  }
});

// 使用正则表达式限制参数
app.get('/users/:userId(\\d+)', (req, res) => {
  // 只有当userId为数字时才会匹配
  res.send(`数字用户ID: ${req.params.userId}`);
});
```

### 查询参数

查询参数是URL中`?`后面的键值对，通常用于过滤、排序或分页等操作。它们会被解析到`req.query`对象中。

```javascript
// 获取所有查询参数
app.get('/search', (req, res) => {
  res.json(req.query);
});

// 处理特定的查询参数
app.get('/products', (req, res) => {
  const { category, minPrice, maxPrice, page = 1 } = req.query;
  
  let response = `搜索产品`;
  if (category) response += `- 类别: ${category}`;
  if (minPrice) response += `- 最低价格: ${minPrice}`;
  if (maxPrice) response += `- 最高价格: ${maxPrice}`;
  response += `- 页码: ${page}`;
  
  res.send(response);
});

// 处理数组查询参数（重复的键）
// URL: /tags?tag=nodejs&tag=express
app.get('/tags', (req, res) => {
  const tags = req.query.tag; // 默认情况下，tag是字符串
  // 可以使用自定义中间件将重复的键转换为数组
  res.send(`标签: ${tags}`);
});
```

## 高级路由技术

### 路由链式调用

可以使用`app.route()`为路由路径创建可链式的路由处理器。

```javascript
app.route('/book')
  .get((req, res) => {
    res.send('获取书籍列表');
  })
  .post((req, res) => {
    res.send('添加新书籍');
  })
  .put((req, res) => {
    res.send('更新书籍信息');
  });
```

### 使用Express Router

Express Router允许将路由组织到模块中，提高代码的组织性和可维护性。

```javascript
// routes/users.js
const express = require('express');
const router = express.Router();

// 用户相关路由
router.get('/', (req, res) => {
  res.send('用户列表');
});

router.get('/:id', (req, res) => {
  res.send(`用户ID: ${req.params.id}`);
});

module.exports = router;

// 在主应用中使用路由
const usersRouter = require('./routes/users');
app.use('/users', usersRouter);
```

### 路由参数处理中间件

可以创建中间件来处理路由参数，在将请求传递给路由处理器之前执行特定逻辑。

```javascript
// 参数处理中间件
app.param('userId', (req, res, next, userId) => {
  // 执行数据库查询或其他逻辑
  console.log(`正在处理用户ID: ${userId}`);
  
  // 可以将处理结果添加到请求对象
  req.user = { id: userId, name: 'John Doe' };
  
  next();
});

// 使用参数中间件的路由
app.get('/users/:userId', (req, res) => {
  // 可以直接使用req.user，因为它已经被中间件处理
  res.send(req.user);
});
```

## 最佳实践

1. **参数验证**：始终验证路由参数和查询参数

   ```javascript
   app.get('/users/:id', (req, res) => {
     const userId = parseInt(req.params.id, 10);
     
     if (isNaN(userId)) {
       return res.status(400).send('无效的用户ID');
     }
     
     // 继续处理...
   });
   ```

2. **使用正则表达式**：对参数格式进行严格限制

   ```javascript
   // 只允许数字ID
   app.get('/users/:userId(\\d+)', (req, res) => {
     // 确保userId是数字
   });
   ```

3. **路由分组**：将相关路由组织在一起，提高代码可维护性

   ```javascript
   // API路由
   app.use('/api', apiRoutes);
   // 管理路由
   app.use('/admin', adminRoutes);
   ```

4. **错误处理**：为路由添加适当的错误处理

   ```javascript
   app.get('/users/:id', async (req, res, next) => {
     try {
       const user = await getUserById(req.params.id);
       if (!user) {
         return res.status(404).send('用户不存在');
       }
       res.json(user);
     } catch (error) {
       next(error); // 传递给错误处理中间件
     }
   });
   ```

## 总结
Express 路由系统提供了强大而灵活的方式来定义API端点，通过路径参数和查询参数，可以创建具有丰富交互性的Web应用程序。合理使用这些特性，并结合良好的代码组织方式，可以构建出结构清晰、易于维护的后端服务。