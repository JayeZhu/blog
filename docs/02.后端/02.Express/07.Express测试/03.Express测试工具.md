---
title: Express测试工具
date: 2025-10-16 15:43:01
permalink: /pages/592bd2/
categories:
  - 后端
tags:
  - Express
  - Express测试
---
## Jest高级用法

### 异步测试处理

```javascript
// Promise测试
describe('Async Tests', () => {
  it('should handle promises', async () => {
    const data = await fetchData();
    expect(data).toBe('expected data');
  });

  // 回调测试
  it('should handle callbacks', (done) => {
    fetchData((error, data) => {
      expect(data).toBe('expected data');
      done();
    });
  });
});
```

### Mock和Spy高级用法

```javascript
// 模拟模块
jest.mock('../api/user', () => ({
  getUser: jest.fn(() => Promise.resolve({ id: 1, name: 'John' }))
}));

// 监控函数调用
describe('Function Spying', () => {
  it('should track function calls', () => {
    const spy = jest.spyOn(console, 'log');
    myFunction();
    expect(spy).toHaveBeenCalledWith('test message');
    spy.mockRestore();
  });
});
```

### 测试环境配置

```javascript
// jest.config.js
module.exports = {
  testEnvironment: 'node',
  setupFilesAfterEnv: ['<rootDir>/test/setup.js'],
  testMatch: [
    '<rootDir>/test/**/*.test.js'
  ],
  moduleNameMapping: {
    '^@/(.*)$': '<rootDir>/src/$1'
  },
  transform: {
    '^.+\\.js$': 'babel-jest'
  }
};
```

### 自定义匹配器

```javascript
// test/setup.js
expect.extend({
  toBeWithinRange(received, floor, ceiling) {
    const pass = received >= floor && received <= ceiling;
    if (pass) {
      return {
        message: () =>
          `expected ${received} not to be within range ${floor} - ${ceiling}`,
        pass: true,
      };
    } else {
      return {
        message: () =>
          `expected ${received} to be within range ${floor} - ${ceiling}`,
        pass: false,
      };
    }
  },
});

// 使用自定义匹配器
test('numeric ranges', () => {
  expect(100).toBeWithinRange(90, 110);
});
```

## 测试覆盖率

### 覆盖率配置

```javascript
// jest.config.js
module.exports = {
  collectCoverage: true,
  coverageDirectory: 'coverage',
  coverageReporters: ['text', 'lcov', 'html'],
  collectCoverageFrom: [
    'src/**/*.js',
    '!src/**/*.test.js',
    '!src/config/**',
  ],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80
    }
  }
};
```

### 覆盖率报告解读

1. **语句覆盖率**
   - 衡量执行的代码语句比例
   - 基本单位：可执行语句

2. **分支覆盖率**
   - 衡量条件分支的执行情况
   - 包括if/else、switch等

3. **函数覆盖率**
   - 衡量被调用的函数比例
   - 关注函数是否被测试

4. **行覆盖率**
   - 衡量执行的代码行比例
   - 最直观的覆盖率指标

### 覆盖率优化策略

```javascript
// 示例：提高分支覆盖率
describe('Conditional Logic', () => {
  it('should handle all branches', () => {
    // 测试true分支
    expect(processData(true)).toBe('handled true');
    
    // 测试false分支
    expect(processData(false)).toBe('handled false');
    
    // 测试异常情况
    expect(() => processData(null)).toThrow();
  });
});
```

## 持续集成测试

### GitHub Actions配置

```yaml
# .github/workflows/test.yml
name: Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [14.x, 16.x, 18.x]

    steps:
    - uses: actions/checkout@v2
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v2
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    - run: npm ci
    - run: npm run test:coverage
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v1
```

### Jenkins Pipeline配置

```groovy
pipeline {
    agent any
    
    stages {
        stage('Test') {
            steps {
                sh 'npm ci'
                sh 'npm run test:coverage'
            }
            post {
                always {
                    publishHTML([
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'coverage',
                        reportFiles: 'lcov-report/index.html',
                        reportName: 'Coverage Report'
                    ])
                }
            }
        }
    }
}
```

### 测试报告集成

```javascript
// jest.config.js
module.exports = {
  reporters: [
    'default',
    ['jest-junit', {
      outputDirectory: 'test-results',
      outputName: 'junit.xml'
    }]
  ]
};
```

### 测试环境管理

```javascript
// test/setup.js
beforeAll(async () => {
  // 设置测试数据库
  await setupTestDatabase();
});

afterAll(async () => {
  // 清理测试环境
  await cleanupTestDatabase();
});

beforeEach(async () => {
  // 重置测试数据
  await resetTestData();
});
```

## 最佳实践建议

1. **测试策略**
   - 保持测试简单
   - 关注测试价值
   - 避免过度测试

2. **覆盖率管理**
   - 设置合理目标
   - 定期检查报告
   - 优先覆盖核心代码

3. **持续集成**
   - 自动化测试流程
   - 快速反馈机制
   - 分阶段测试策略

通过深入使用Jest的高级功能，合理配置测试覆盖率，并建立完善的持续集成流程，可以大大提高Express应用的测试质量和开发效率。