---
title: Express测试分类
date: 2025-10-16 15:41:06
permalink: /pages/fb5473/
categories:
  - 后端
tags:
  - Express
  - Express测试
---
## 单元测试

### 路由测试

```javascript
// test/unit/routes.test.js
const request = require('supertest');
const app = require('../../app');

describe('User Routes', () => {
  it('should create a new user', async () => {
    const response = await request(app)
      .post('/api/users')
      .send({ name: 'John', email: 'john@example.com' })
      .expect(201);
    
    expect(response.body.name).toBe('John');
  });

  it('should get user by ID', async () => {
    const response = await request(app)
      .get('/api/users/123')
      .expect(200);
    
    expect(response.body).toHaveProperty('name');
  });
});
```

### 中间件测试

```javascript
// test/unit/middleware.test.js
const auth = require('../../middleware/auth');
const { Request, Response } = require('mock-express');

describe('Auth Middleware', () => {
  it('should pass with valid token', () => {
    const req = new Request({ headers: { authorization: 'Bearer validtoken' }});
    const res = new Response();
    const next = jest.fn();
    
    auth(req, res, next);
    expect(next).toHaveBeenCalled();
  });

  it('should reject with invalid token', () => {
    const req = new Request({ headers: { authorization: 'Bearer invalidtoken' }});
    const res = new Response();
    const next = jest.fn();
    
    auth(req, res, next);
    expect(res.status).toHaveBeenCalledWith(401);
  });
});
```

### 工具函数测试

```javascript
// test/unit/utils.test.js
const { validateEmail } = require('../../utils/validators');

describe('Email Validator', () => {
  it('should validate correct email', () => {
    expect(validateEmail('test@example.com')).toBe(true);
  });

  it('should reject invalid email', () => {
    expect(validateEmail('invalid-email')).toBe(false);
  });
});
```

### Mock和Stub使用

```javascript
// test/unit/user.service.test.js
const userService = require('../../services/userService');
const User = require('../../models/User');

describe('User Service', () => {
  beforeEach(() => {
    jest.clearAllMocks();
  });

  it('should create user with valid data', async () => {
    const mockUser = { id: 1, name: 'John' };
    jest.spyOn(User, 'create').mockResolvedValue(mockUser);
    
    const result = await userService.createUser({ name: 'John' });
    expect(User.create).toHaveBeenCalled();
    expect(result).toEqual(mockUser);
  });
});
```

## 集成测试

### API集成测试

```javascript
// test/integration/api.test.js
const request = require('supertest');
const app = require('../../app');

describe('API Integration', () => {
  it('should handle complete user flow', async () => {
    // 创建用户
    const createResponse = await request(app)
      .post('/api/users')
      .send({ name: 'John', email: 'john@example.com' });
    
    // 获取用户
    const getResponse = await request(app)
      .get(`/api/users/${createResponse.body.id}`);
    
    expect(getResponse.body.name).toBe('John');
  });
});
```

### 数据库集成测试

```javascript
// test/integration/database.test.js
const mongoose = require('mongoose');
const User = require('../../models/User');

describe('Database Integration', () => {
  beforeAll(async () => {
    await mongoose.connect(process.env.TEST_DB_URL);
  });

  afterAll(async () => {
    await mongoose.connection.close();
  });

  it('should save and retrieve user from database', async () => {
    const user = new User({ name: 'John', email: 'john@example.com' });
    await user.save();
    
    const foundUser = await User.findOne({ email: 'john@example.com' });
    expect(foundUser.name).toBe('John');
  });
});
```

### 中间件集成测试

```javascript
// test/integration/middleware.test.js
const request = require('supertest');
const app = require('../../app');

describe('Middleware Integration', () => {
  it('should apply auth middleware to protected routes', async () => {
    const response = await request(app)
      .get('/api/protected')
      .expect(401);
    
    expect(response.body.error).toContain('Unauthorized');
  });
});
```

### 错误处理测试

```javascript
// test/integration/error-handling.test.js
const request = require('supertest');
const app = require('../../app');

describe('Error Handling', () => {
  it('should handle validation errors', async () => {
    const response = await request(app)
      .post('/api/users')
      .send({ email: 'invalid-email' })
      .expect(400);
    
    expect(response.body.error).toBeDefined();
  });
});
```

## API测试

### RESTful API测试

```javascript
// test/api/rest.test.js
const request = require('supertest');
const app = require('../../app');

describe('RESTful API', () => {
  it('should support all CRUD operations', async () => {
    // CREATE
    const createResponse = await request(app)
      .post('/api/users')
      .send({ name: 'John' });
    
    // READ
    await request(app)
      .get(`/api/users/${createResponse.body.id}`)
      .expect(200);
    
    // UPDATE
    await request(app)
      .put(`/api/users/${createResponse.body.id}`)
      .send({ name: 'Jane' })
      .expect(200);
    
    // DELETE
    await request(app)
      .delete(`/api/users/${createResponse.body.id}`)
      .expect(204);
  });
});
```

### 请求/响应验证

```javascript
// test/api/validation.test.js
const request = require('supertest');
const app = require('../../app');

describe('Request/Response Validation', () => {
  it('should validate request body', async () => {
    const response = await request(app)
      .post('/api/users')
      .send({ name: '' })
      .expect(400);
    
    expect(response.body.error).toContain('Name is required');
  });

  it('should return correct response format', async () => {
    const response = await request(app)
      .get('/api/users/123')
      .expect(200);
    
    expect(response.body).toHaveProperty('id');
    expect(response.body).toHaveProperty('name');
  });
});
```

### 状态码测试

```javascript
// test/api/status-codes.test.js
const request = require('supertest');
const app = require('../../app');

describe('Status Codes', () => {
  it('should return correct status codes', async () => {
    // 成功请求
    await request(app)
      .get('/api/users')
      .expect(200);
    
    // 资源未找到
    await request(app)
      .get('/api/users/999')
      .expect(404);
    
    // 验证错误
    await request(app)
      .post('/api/users')
      .send({})
      .expect(400);
  });
});
```

### 性能测试

```javascript
// test/api/performance.test.js
const request = require('supertest');
const app = require('../../app');

describe('Performance Tests', () => {
  it('should handle concurrent requests', async () => {
    const promises = Array(100).fill().map(() =>
      request(app).get('/api/users')
    );
    
    const responses = await Promise.all(promises);
    responses.forEach(response => {
      expect(response.status).toBe(200);
    });
  });
});
```

## 端到端测试

### 完整流程测试

```javascript
// test/e2e/workflow.test.js
const request = require('supertest');
const app = require('../../app');

describe('E2E Workflow', () => {
  it('should complete full user journey', async () => {
    // 注册
    const registerResponse = await request(app)
      .post('/api/register')
      .send({
        email: 'test@example.com',
        password: 'password123'
      });
    
    // 登录
    const loginResponse = await request(app)
      .post('/api/login')
      .send({
        email: 'test@example.com',
        password: 'password123'
      });
    
    // 访问受保护路由
    await request(app)
      .get('/api/profile')
      .set('Authorization', `Bearer ${loginResponse.body.token}`)
      .expect(200);
  });
});
```

### 用户场景模拟

```javascript
// test/e2e/user-scenarios.test.js
const request = require('supertest');
const app = require('../../app');

describe('User Scenarios', () => {
  it('should handle admin user scenario', async () => {
    // 管理员登录
    const loginResponse = await request(app)
      .post('/api/login')
      .send({
        email: 'admin@example.com',
        password: 'admin123'
      });
    
    // 创建用户
    await request(app)
      .post('/api/users')
      .set('Authorization', `Bearer ${loginResponse.body.token}`)
      .send({
        name: 'New User',
        email: 'newuser@example.com'
      });
    
    // 验证用户创建
    const users = await request(app)
      .get('/api/users')
      .set('Authorization', `Bearer ${loginResponse.body.token}`);
    
    expect(users.body).toContainEqual(
      expect.objectContaining({
        name: 'New User',
        email: 'newuser@example.com'
      })
    );
  });
});
```

### 浏览器自动化测试

```javascript
// test/e2e/browser.test.js
const puppeteer = require('puppeteer');

describe('Browser Automation', () => {
  let browser;
  let page;

  beforeAll(async () => {
    browser = await puppeteer.launch();
    page = await browser.newPage();
  });

  afterAll(async () => {
    await browser.close();
  });

  it('should handle user interaction', async () => {
    await page.goto('http://localhost:3000');
    
    // 填写表单
    await page.type('#email', 'test@example.com');
    await page.type('#password', 'password123');
    
    // 点击提交
    await page.click('#submit');
    
    // 验证结果
    await page.waitForSelector('.welcome-message');
    const text = await page.$eval('.welcome-message', el => el.textContent);
    expect(text).toContain('Welcome');
  });
});
```

## 最佳实践建议

1. **测试组织**
   - 按功能模块分组
   - 保持测试独立性
   - 使用描述性命名

2. **测试数据**
   - 使用固定测试数据
   - 确保数据隔离
   - 及时清理测试数据

3. **断言策略**
   - 验证关键行为
   - 避免过度断言
   - 使用有意义的错误消息

通过这些不同类型的测试，可以全面验证Express应用的功能、性能和可靠性，确保应用质量。