---
title: Express API版本
date: 2025-10-15 17:41:41
permalink: /pages/e09fdb/
categories:
  - 后端
tags:
  - Express
  - Express RESTful
---
## 版本管理策略

### 1. URL路径版本控制

```javascript
// v1 API
app.use('/api/v1/users', userRoutesV1);
app.use('/api/v1/posts', postRoutesV1);

// v2 API
app.use('/api/v2/users', userRoutesV2);
app.use('/api/v2/posts', postRoutesV2);
```

### 2. 请求头版本控制

```javascript
// 版本检测中间件
const detectVersion = (req, res, next) => {
  const version = req.headers['api-version'] || 'v1';
  req.apiVersion = version;
  next();
};

app.use(detectVersion);

// 版本路由分发
app.use('/api/users', (req, res, next) => {
  if (req.apiVersion === 'v2') {
    return userRoutesV2(req, res, next);
  }
  userRoutesV1(req, res, next);
});
```

### 3. 查询参数版本控制

```javascript
app.use('/api/users', (req, res, next) => {
  const version = req.query.version || 'v1';
  req.apiVersion = version;
  next();
});
```

## 版本实现示例

### 基础版本结构

```
project/
├── routes/
│   ├── v1/
│   │   ├── users.js
│   │   └── posts.js
│   └── v2/
│       ├── users.js
│       └── posts.js
├── controllers/
│   ├── v1/
│   │   └── userController.js
│   └── v2/
│       └── userController.js
└── app.js
```

### 版本路由实现

```javascript
// routes/v1/users.js
const express = require('express');
const router = express.Router();
const userController = require('../../controllers/v1/userController');

router.get('/', userController.getUsers);
router.get('/:id', userController.getUser);
router.post('/', userController.createUser);

module.exports = router;

// routes/v2/users.js
const express = require('express');
const router = express.Router();
const userController = require('../../controllers/v2/userController');

router.get('/', userController.getUsers);
router.get('/:id', userController.getUser);
router.post('/', userController.createUser);
// v2 新增功能
router.patch('/:id/status', userController.updateUserStatus);

module.exports = router;
```

### 版本控制器实现

```javascript
// controllers/v1/userController.js
const User = require('../../models/User');

const getUsers = async (req, res) => {
  try {
    const users = await User.find();
    res.json({
      status: 200,
      data: users
    });
  } catch (error) {
    res.status(500).json({
      status: 500,
      error: error.message
    });
  }
};

// controllers/v2/userController.js
const User = require('../../models/User');

const getUsers = async (req, res) => {
  try {
    const { page = 1, limit = 10 } = req.query;
    const users = await User.find()
      .limit(limit * 1)
      .skip((page - 1) * limit);
    
    const total = await User.countDocuments();
    
    res.json({
      status: 200,
      data: {
        items: users,
        pagination: {
          page: parseInt(page),
          limit: parseInt(limit),
          total
        }
      }
    });
  } catch (error) {
    res.status(500).json({
      status: 500,
      error: error.message
    });
  }
};
```

## 版本兼容性处理

### 数据模型版本控制

```javascript
// models/User.js
const userSchema = new mongoose.Schema({
  name: String,
  email: String,
  // v2新增字段
  profile: {
    type: Map,
    of: String,
    default: {}
  }
});

// 版本中间件
const adaptResponse = (req, res, next) => {
  const originalJson = res.json;
  
  res.json = function(data) {
    if (req.apiVersion === 'v1' && data.data) {
      // 移除v2新增字段
      if (Array.isArray(data.data)) {
        data.data = data.data.map(item => {
          const { profile, ...v1Data } = item;
          return v1Data;
        });
      } else {
        const { profile, ...v1Data } = data.data;
        data.data = v1Data;
      }
    }
    originalJson.call(this, data);
  };
  
  next();
};
```

### 版本废弃处理

```javascript
// 废弃版本中间件
const deprecationWarning = (version, deprecatedVersion) => (req, res, next) => {
  if (req.apiVersion === deprecatedVersion) {
    res.set('Deprecation', 'true');
    res.set('Sunset', new Date(Date.now() + 30 * 24 * 60 * 60 * 1000));
    res.set('Link', `</api/${version}/users>; rel="successor-version"`);
  }
  next();
};

// 使用示例
app.use('/api/v1/users', deprecationWarning('v2', 'v1'), userRoutesV1);
```

## 最佳实践

### 1. 版本策略选择

```javascript
// 版本配置
const versionConfig = {
  default: 'v1',
  supported: ['v1', 'v2'],
  deprecated: ['v1'],
  sunset: {
    v1: new Date('2024-01-01')
  }
};

// 版本验证中间件
const validateVersion = (req, res, next) => {
  const version = req.headers['api-version'] || versionConfig.default;
  
  if (!versionConfig.supported.includes(version)) {
    return res.status(400).json({
      error: 'Unsupported API version',
      supported_versions: versionConfig.supported
    });
  }
  
  req.apiVersion = version;
  next();
};
```

### 2. 错误处理

```javascript
// 版本特定错误处理
const versionErrorHandler = (err, req, res, next) => {
  const errorHandler = require(`./errors/${req.apiVersion}`);
  errorHandler.handle(err, req, res, next);
};

// errors/v1/index.js
const handle = (err, req, res, next) => {
  res.status(err.status || 500).json({
    status: err.status || 500,
    error: err.message
  });
};

// errors/v2/index.js
const handle = (err, req, res, next) => {
  res.status(err.status || 500).json({
    status: err.status || 500,
    error: {
      code: err.code || 'UNKNOWN_ERROR',
      message: err.message,
      details: err.details || null
    }
  });
};
```

### 3. 文档管理

```javascript
// API文档路由
app.get('/api/docs', (req, res) => {
  const version = req.query.version || versionConfig.default;
  const docs = require(`./docs/${version}`);
  res.json(docs);
});

// docs/v1.json
{
  "version": "v1",
  "endpoints": {
    "users": {
      "GET": "/api/v1/users",
      "POST": "/api/v1/users"
    }
  }
}
```

## 总结

Express API版本管理的关键点：

1. **选择合适的版本策略**
   - URL路径版本控制（推荐）
   - 请求头版本控制
   - 查询参数版本控制

2. **保持向后兼容**
   - 数据模型适配
   - 响应格式兼容
   - 渐进式升级

3. **版本生命周期管理**
   - 版本废弃通知
   - 日落计划
   - 迁移指南

4. **文档和测试**
   - 版本特定文档
   - 版本兼容性测试
   - 迁移测试

通过合理的版本管理策略，可以确保API的平滑升级和向后兼容性，同时为开发者提供清晰的迁移路径。