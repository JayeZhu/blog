---
title: Express RESTful 设计
date: 2025-10-15 17:34:10
permalink: /pages/d098b6/
categories:
  - 后端
tags:
  - Express
  - Express RESTful
---
## RESTful 架构原则

### 1. 客户端-服务器分离
- 客户端和服务器应该独立演进
- 通过标准接口进行通信
- 提高系统的可维护性和可扩展性

```javascript
// 服务器端
app.get('/api/users', (req, res) => {
  // 处理请求并返回数据
  res.json(users);
});

// 客户端
fetch('/api/users')
  .then(response => response.json())
  .then(data => console.log(data));
```

### 2. 无状态
- 每个请求必须包含所有必要信息
- 服务器不存储客户端上下文
- 提高系统的可伸缩性

```javascript
// 不好的实践：依赖服务器状态
app.get('/api/user/profile', (req, res) => {
  // 假设用户信息存储在服务器会话中
  res.json(req.session.user);
});

// 好的实践：每个请求包含认证信息
app.get('/api/user/profile', authenticateToken, (req, res) => {
  // 从请求中获取用户信息
  res.json(req.user);
});
```

### 3. 可缓存
- 响应数据应该标记为可缓存或不可缓存
- 提高系统性能和可伸缩性

```javascript
// 设置缓存头
app.get('/api/posts', (req, res) => {
  res.set('Cache-Control', 'public, max-age=300');
  res.json(posts);
});
```

### 4. 统一接口
- 使用标准方法和状态码
- 资源标识清晰
- 自描述消息

```javascript
// 统一的资源命名
app.get('/api/users/:id', getUser);
app.put('/api/users/:id', updateUser);
app.delete('/api/users/:id', deleteUser);
```

### 5. 分层系统
- 系统可以由多个层次组成
- 每层只能看到直接相邻的一层

```javascript
// 请求通过多个层次处理
app.use('/api', authenticate); // 认证层
app.use('/api', rateLimit);    // 限流层
app.use('/api', logRequest);   // 日志层
```

## 资源设计

### 资源命名规范

```javascript
// 好的实践：使用名词复数
app.get('/api/users');     // 获取用户列表
app.get('/api/posts');     // 获取文章列表
app.get('/api/comments');  // 获取评论列表

// 避免使用动词
// 错误示例：
app.get('/api/getUsers');
app.post('/api/createUser');
```

### 资源嵌套

```javascript
// 嵌套资源
app.get('/api/users/:userId/posts');     // 获取用户的文章
app.post('/api/users/:userId/posts');    // 为用户创建文章
app.get('/api/posts/:postId/comments');  // 获取文章的评论

// 避免过深嵌套
// 不推荐：
app.get('/api/users/:userId/posts/:postId/comments/:commentId/replies');
```

### 资源过滤

```javascript
// 查询参数过滤
app.get('/api/posts', (req, res) => {
  const { category, author, published } = req.query;
  let filteredPosts = posts;
  
  if (category) {
    filteredPosts = filteredPosts.filter(post => post.category === category);
  }
  if (author) {
    filteredPosts = filteredPosts.filter(post => post.author === author);
  }
  if (published !== undefined) {
    filteredPosts = filteredPosts.filter(post => post.published === (published === 'true'));
  }
  
  res.json(filteredPosts);
});
```

## HTTP 方法

### 常用 HTTP 方法

| 方法 | 用途 | 幂等性 | 安全性 |
|------|------|--------|--------|
| GET | 获取资源 | 是 | 是 |
| POST | 创建资源 | 否 | 否 |
| PUT | 完整更新资源 | 是 | 否 |
| PATCH | 部分更新资源 | 否 | 否 |
| DELETE | 删除资源 | 是 | 否 |

### Express 实现

```javascript
// GET - 获取资源
app.get('/api/users/:id', async (req, res) => {
  try {
    const user = await User.findById(req.params.id);
    if (!user) {
      return res.status(404).json({ error: 'User not found' });
    }
    res.json(user);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// POST - 创建资源
app.post('/api/users', async (req, res) => {
  try {
    const user = new User(req.body);
    await user.save();
    res.status(201).json(user);
  } catch (error) {
    res.status(400).json({ error: error.message });
  }
});

// PUT - 完整更新资源
app.put('/api/users/:id', async (req, res) => {
  try {
    const user = await User.findByIdAndUpdate(
      req.params.id,
      req.body,
      { new: true }
    );
    if (!user) {
      return res.status(404).json({ error: 'User not found' });
    }
    res.json(user);
  } catch (error) {
    res.status(400).json({ error: error.message });
  }
});

// PATCH - 部分更新资源
app.patch('/api/users/:id', async (req, res) => {
  try {
    const user = await User.findById(req.params.id);
    if (!user) {
      return res.status(404).json({ error: 'User not found' });
    }
    
    // 只更新提供的字段
    Object.assign(user, req.body);
    await user.save();
    
    res.json(user);
  } catch (error) {
    res.status(400).json({ error: error.message });
  }
});

// DELETE - 删除资源
app.delete('/api/users/:id', async (req, res) => {
  try {
    const user = await User.findByIdAndDelete(req.params.id);
    if (!user) {
      return res.status(404).json({ error: 'User not found' });
    }
    res.status(204).send();
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});
```

## 状态码使用

### 常用状态码

| 状态码 | 含义 | 使用场景 |
|--------|------|----------|
| 200 | OK | 成功获取或更新资源 |
| 201 | Created | 成功创建资源 |
| 204 | No Content | 成功删除资源 |
| 400 | Bad Request | 客户端请求错误 |
| 401 | Unauthorized | 未认证 |
| 403 | Forbidden | 无权限 |
| 404 | Not Found | 资源不存在 |
| 500 | Internal Server Error | 服务器错误 |

### Express 实现

```javascript
// 成功响应
app.get('/api/users/:id', async (req, res) => {
  const user = await User.findById(req.params.id);
  if (user) {
    res.status(200).json(user);
  } else {
    res.status(404).json({ error: 'User not found' });
  }
});

// 创建资源
app.post('/api/users', async (req, res) => {
  try {
    const user = await User.create(req.body);
    res.status(201).json(user);
  } catch (error) {
    res.status(400).json({ error: error.message });
  }
});

// 删除资源
app.delete('/api/users/:id', async (req, res) => {
  const user = await User.findByIdAndDelete(req.params.id);
  if (user) {
    res.status(204).send();
  } else {
    res.status(404).json({ error: 'User not found' });
  }
});

// 错误处理
app.use((err, req, res, next) => {
  console.error(err.stack);
  res.status(500).json({ error: 'Internal Server Error' });
});
```

## Express 实现

### 项目结构

```
project/
├── routes/
│   ├── users.js
│   ├── posts.js
│   └── index.js
├── controllers/
│   ├── userController.js
│   └── postController.js
├── models/
│   ├── User.js
│   └── Post.js
├── middleware/
│   ├── auth.js
│   └── validation.js
└── app.js
```

### 完整示例

```javascript
// routes/users.js
const express = require('express');
const router = express.Router();
const userController = require('../controllers/userController');
const auth = require('../middleware/auth');

// GET /api/users
router.get('/', userController.getUsers);

// GET /api/users/:id
router.get('/:id', userController.getUser);

// POST /api/users
router.post('/', userController.createUser);

// PUT /api/users/:id
router.put('/:id', auth, userController.updateUser);

// DELETE /api/users/:id
router.delete('/:id', auth, userController.deleteUser);

module.exports = router;

// controllers/userController.js
const User = require('../models/User');

const getUsers = async (req, res) => {
  try {
    const users = await User.find();
    res.json(users);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
};

const getUser = async (req, res) => {
  try {
    const user = await User.findById(req.params.id);
    if (!user) {
      return res.status(404).json({ error: 'User not found' });
    }
    res.json(user);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
};

const createUser = async (req, res) => {
  try {
    const user = new User(req.body);
    await user.save();
    res.status(201).json(user);
  } catch (error) {
    res.status(400).json({ error: error.message });
  }
};

const updateUser = async (req, res) => {
  try {
    const user = await User.findByIdAndUpdate(
      req.params.id,
      req.body,
      { new: true }
    );
    if (!user) {
      return res.status(404).json({ error: 'User not found' });
    }
    res.json(user);
  } catch (error) {
    res.status(400).json({ error: error.message });
  }
};

const deleteUser = async (req, res) => {
  try {
    const user = await User.findByIdAndDelete(req.params.id);
    if (!user) {
      return res.status(404).json({ error: 'User not found' });
    }
    res.status(204).send();
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
};

module.exports = {
  getUsers,
  getUser,
  createUser,
  updateUser,
  deleteUser
};
```

## 最佳实践

### 1. 版本控制

```javascript
// 使用URL版本控制
app.use('/api/v1/users', userRoutes);
app.use('/api/v2/users', userRoutesV2);

// 或使用请求头版本控制
app.use('/api/users', (req, res, next) => {
  const version = req.headers['api-version'];
  if (version === 'v2') {
    return userRoutesV2(req, res, next);
  }
  userRoutes(req, res, next);
});
```

### 2. 分页实现

```javascript
app.get('/api/posts', async (req, res) => {
  const page = parseInt(req.query.page) || 1;
  const limit = parseInt(req.query.limit) || 10;
  const skip = (page - 1) * limit;

  const posts = await Post.find()
    .skip(skip)
    .limit(limit);

  const total = await Post.countDocuments();

  res.json({
    posts,
    pagination: {
      page,
      limit,
      total,
      pages: Math.ceil(total / limit)
    }
  });
});
```

### 3. 错误处理

```javascript
// 统一错误处理中间件
const errorHandler = (err, req, res, next) => {
  if (err.name === 'ValidationError') {
    return res.status(400).json({
      error: 'Validation Error',
      details: Object.values(err.errors).map(e => ({
        field: e.path,
        message: e.message
      }))
    });
  }

  if (err.code === 11000) {
    return res.status(409).json({
      error: 'Duplicate Key Error',
      message: 'Resource already exists'
    });
  }

  res.status(500).json({
    error: 'Internal Server Error',
    message: process.env.NODE_ENV === 'development' ? err.message : 'Something went wrong'
  });
};

app.use(errorHandler);
```

### 4. 响应格式标准化

```javascript
// 统一响应格式
const sendResponse = (res, status, data, message = '') => {
  res.status(status).json({
    status,
    message,
    data
  });
};

// 使用示例
app.get('/api/users/:id', async (req, res) => {
  try {
    const user = await User.findById(req.params.id);
    if (!user) {
      return sendResponse(res, 404, null, 'User not found');
    }
    sendResponse(res, 200, user);
  } catch (error) {
    sendResponse(res, 500, null, error.message);
  }
});
```

## 总结

设计 RESTful API 时，需要遵循以下核心原则：

1. **资源导向**：使用名词表示资源
2. **统一接口**：使用标准 HTTP 方法和状态码
3. **无状态**：每个请求包含所有必要信息
4. **可缓存**：合理使用缓存提高性能
5. **分层系统**：保持系统层次清晰

通过合理使用 Express 的路由、中间件和错误处理机制，可以构建出符合 RESTful 原则的 API。记住，好的 API 设计不仅需要遵循规范，还需要考虑实际业务需求和用户体验。