---
title: Express性能监控
date: 2025-10-16 15:54:41
permalink: /pages/e48eee/
categories:
  - 后端
tags:
  - Express
  - Express性能
---
# Express性能监控实践指南

## 性能监控概述

### 监控指标体系

1. **核心性能指标**
   - 响应时间
   - 吞吐量(QPS)
   - 错误率
   - 并发用户数

2. **资源指标**
   - CPU使用率
   - 内存占用
   - 磁盘I/O
   - 网络流量

## 监控实现方案

### 1. 基础监控

```javascript
// 响应时间监控
const responseTime = require('response-time');

app.use(responseTime((req, res, time) => {
  console.log(`${req.method} ${req.url} - ${time}ms`);
}));

// 状态码监控
app.use((req, res, next) => {
  res.on('finish', () => {
    if (res.statusCode >= 400) {
      console.error(`Error ${res.statusCode} at ${req.url}`);
    }
  });
  next();
});
```

### 2. 系统资源监控

```javascript
// 内存监控
setInterval(() => {
  const memoryUsage = process.memoryUsage();
  console.log('Memory Usage:', {
    rss: `${Math.round(memoryUsage.rss / 1024 / 1024)} MB`,
    heapTotal: `${Math.round(memoryUsage.heapTotal / 1024 / 1024)} MB`,
    heapUsed: `${Math.round(memoryUsage.heapUsed / 1024 / 1024)} MB`
  });
}, 60000);

// CPU监控
const os = require('os');
setInterval(() => {
  const cpus = os.cpus();
  const usage = process.cpuUsage();
  console.log('CPU Usage:', usage);
}, 60000);
```

### 3. 专业监控工具

1. **PM2监控**
```javascript
// ecosystem.config.js
module.exports = {
  apps: [{
    name: 'express-app',
    script: 'app.js',
    instances: 'max',
    exec_mode: 'cluster',
    monitoring: true
  }]
};
```

2. **APM集成**
```javascript
// New Relic
const newrelic = require('newrelic');

// 自定义指标
newrelic.recordMetric('Custom/MetricName', value);
```

## 监控数据处理

### 1. 日志收集

```javascript
// 日志记录中间件
const winston = require('winston');
const logger = winston.createLogger({
  level: 'info',
  format: winston.format.json(),
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' })
  ]
});

app.use((req, res, next) => {
  logger.info({
    method: req.method,
    url: req.url,
    userAgent: req.get('User-Agent'),
    timestamp: new Date()
  });
  next();
});
```

### 2. 性能数据存储

```javascript
// Redis存储性能数据
const redis = require('redis');
const client = redis.createClient();

const storeMetrics = async (metrics) => {
  const key = `metrics:${Date.now()}`;
  await client.hmset(key, metrics);
  await client.expire(key, 86400); // 24小时过期
};
```

## 监控报警系统

### 1. 阈值报警

```javascript
// 性能阈值检查
const checkThresholds = () => {
  const metrics = getMetrics();
  
  if (metrics.responseTime > 1000) {
    alertManager.notify('High response time detected');
  }
  
  if (metrics.memoryUsage > 0.8) {
    alertManager.notify('High memory usage detected');
  }
};
```

### 2. 报警通知

```javascript
// 邮件通知
const nodemailer = require('nodemailer');

const sendAlert = async (message) => {
  const transporter = nodemailer.createTransporter({
    service: 'gmail',
    auth: {
      user: 'your-email@gmail.com',
      pass: 'your-password'
    }
  });

  await transporter.sendMail({
    from: 'alerts@yourapp.com',
    to: 'admin@yourapp.com',
    subject: 'Performance Alert',
    text: message
  });
};
```

## 监控最佳实践

### 1. 监控策略

1. **分层监控**
   - 应用层
   - 中间件层
   - 数据库层

2. **监控频率**
   - 实时指标：秒级
   - 趋势分析：分钟级
   - 统计报告：小时/天

### 2. 性能优化建议

1. **基于监控数据优化**
   - 识别性能瓶颈
   - 分析资源使用模式
   - 制定优化策略

2. **持续改进**
   - 定期评估
   - 调整监控指标
   - 优化报警规则

## 监控工具推荐

1. **开源工具**
   - Prometheus + Grafana
   - ELK Stack
   - PM2 Monitoring

2. **商业方案**
   - New Relic
   - Datadog
   - AppDynamics

通过实施这些监控策略，可以全面掌握Express应用的运行状态，及时发现和解决性能问题，确保应用的稳定运行。