---
title: Express性能优化
date: 2025-10-16 15:52:37
permalink: /pages/b95351/
categories:
  - 后端
tags:
  - Express
  - Express性能
---
# Express性能优化指南

## 性能优化基础

### 优化目标

1. **响应时间**：降低请求处理时间
2. **吞吐量**：提高单位时间处理请求数
3. **资源利用**：优化CPU、内存使用
4. **并发处理**：提升同时处理请求能力

## 代码层面优化

### 1. 异步处理优化

```javascript
// 避免阻塞操作
app.get('/data', async (req, res) => {
  // 好的做法：使用异步操作
  const data = await fetchDataAsync();
  res.json(data);
});

// 避免：同步阻塞操作
app.get('/data', (req, res) => {
  const data = fetchDataSync(); // 阻塞操作
  res.json(data);
});
```

### 2. 中间件优化

```javascript
// 精简中间件链
app.use(compression()); // 启用gzip压缩
app.use(express.json({ limit: '10kb' })); // 限制请求体大小

// 条件性使用中间件
app.use('/api', apiMiddleware); // 只在特定路由使用
```

### 3. 错误处理优化

```javascript
// 集中错误处理
app.use((err, req, res, next) => {
  console.error(err.stack);
  res.status(500).json({
    error: 'Internal Server Error'
  });
});

// 避免在路由中重复错误处理
```

## 缓存策略

### 1. 内存缓存

```javascript
const NodeCache = require('node-cache');
const cache = new NodeCache({ stdTTL: 3600 }); // 1小时过期

app.get('/api/data', (req, res) => {
  const cacheKey = 'data_key';
  let data = cache.get(cacheKey);
  
  if (!data) {
    data = fetchFromDatabase();
    cache.set(cacheKey, data);
  }
  
  res.json(data);
});
```

### 2. Redis缓存

```javascript
const redis = require('redis');
const client = redis.createClient();

app.get('/api/data', async (req, res) => {
  const cacheKey = 'data_key';
  
  try {
    const cached = await client.get(cacheKey);
    if (cached) {
      return res.json(JSON.parse(cached));
    }
    
    const data = await fetchFromDatabase();
    await client.set(cacheKey, JSON.stringify(data), 'EX', 3600);
    res.json(data);
  } catch (err) {
    next(err);
  }
});
```

## 数据库优化

### 1. 连接池配置

```javascript
const pool = mysql.createPool({
  connectionLimit: 10,
  host: 'localhost',
  user: 'root',
  password: 'password',
  database: 'mydb',
  acquireTimeout: 60000,
  timeout: 60000
});

// 使用连接池
app.get('/users', (req, res) => {
  pool.query('SELECT * FROM users', (error, results) => {
    if (error) throw error;
    res.json(results);
  });
});
```

### 2. 查询优化

```javascript
// 使用索引
app.get('/users/:id', async (req, res) => {
  // 优化查询：只选择必要字段
  const user = await User.findById(req.params.id)
    .select('name email');
  res.json(user);
});

// 批量操作
app.post('/users/batch', async (req, res) => {
  const users = req.body;
  // 使用批量插入
  await User.insertMany(users);
  res.json({ success: true });
});
```

## 静态资源优化

### 1. 资源压缩

```javascript
const compression = require('compression');
app.use(compression({
  level: 6,
  threshold: 1024
}));

// 静态文件优化
app.use(express.static('public', {
  maxAge: '1d',
  etag: true,
  lastModified: true
}));
```

### 2. CDN集成

```javascript
// CDN配置
const CDN_URL = process.env.CDN_URL || '';

app.use((req, res, next) => {
  res.locals.CDN_URL = CDN_URL;
  next();
});

// 在模板中使用
// ${CDN_URL}/styles/main.css
```

## 集群与负载均衡

### 1. 集群模式

```javascript
const cluster = require('cluster');
const numCPUs = require('os').cpus().length;

if (cluster.isMaster) {
  for (let i = 0; i < numCPUs; i++) {
    cluster.fork();
  }
  
  cluster.on('exit', (worker) => {
    console.log(`Worker ${worker.id} died`);
    cluster.fork();
  });
} else {
  require('./app.js');
}
```

### 2. 负载均衡

```javascript
// 使用PM2集群
// ecosystem.config.js
module.exports = {
  apps: [{
    name: 'myapp',
    script: 'app.js',
    instances: 'max',
    exec_mode: 'cluster',
    max_memory_restart: '1G'
  }]
};
```