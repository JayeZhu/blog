---
title: Express服务器部署
date: 2025-10-16 16:14:40
permalink: /pages/59c47d/
categories:
  - 后端
tags:
  - Express
  - Express部署
---
# Express服务器部署指南

## 前期准备

### 服务器选择
1. 云服务商选择
   - AWS
   - 阿里云
   - 腾讯云
   - DigitalOcean

2. 服务器配置要求
   - CPU: 至少1核
   - 内存: 至少1GB
   - 存储: 至少20GB SSD
   - 带宽: 根据需求选择

### 基础环境配置

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装Node.js
curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
sudo apt-get install -y nodejs

# 验证安装
node -v
npm -v

# 安装PM2
sudo npm install pm2 -g
```

## 项目部署

### 1. 代码上传

```bash
# 创建项目目录
sudo mkdir /var/www/myapp
sudo chown $USER:$USER /var/www/myapp
cd /var/www/myapp

# 克隆代码
git clone https://github.com/yourusername/your-repo.git .

# 安装依赖
npm install --production
```

### 2. 环境配置

```bash
# 创建环境变量文件
sudo nano .env
```

```env
NODE_ENV=production
PORT=3000
DATABASE_URL=your_database_url
JWT_SECRET=your_jwt_secret
```

### 3. PM2配置

```javascript
// ecosystem.config.js
module.exports = {
  apps: [{
    name: 'myapp',
    script: 'app.js',
    instances: 'max',
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'development'
    },
    env_production: {
      NODE_ENV: 'production'
    },
    error_file: './logs/err.log',
    out_file: './logs/out.log',
    log_file: './logs/combined.log',
    time: true
  }]
};
```

### 4. 启动应用

```bash
# 创建日志目录
mkdir logs

# 启动应用
pm2 start ecosystem.config.js --env production

# 保存PM2配置
pm2 save

# 设置开机自启
pm2 startup
```

## Web服务器配置

### Nginx配置

```bash
# 安装Nginx
sudo apt install nginx -y

# 创建站点配置
sudo nano /etc/nginx/sites-available/myapp
```

```nginx
server {
    listen 80;
    server_name your_domain.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
```

```bash
# 启用配置
sudo ln -s /etc/nginx/sites-available/myapp /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

## SSL证书配置

### Let's Encrypt证书

```bash
# 安装Certbot
sudo apt install certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d your_domain.com

# 设置自动续期
sudo crontab -e
# 添加以下行
0 12 * * * /usr/bin/certbot renew --quiet
```

## 数据库配置

### MongoDB设置

```bash
# 安装MongoDB
wget -qO - https://www.mongodb.org/static/pgp/server-5.0.asc | sudo apt-key add -
echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/5.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-5.0.list
sudo apt-get update
sudo apt-get install -y mongodb-org

# 启动MongoDB
sudo systemctl start mongod
sudo systemctl enable mongod
```

## 安全配置

### 1. 防火墙设置

```bash
# 启用UFW
sudo ufw enable

# 允许SSH
sudo ufw allow ssh

# 允许HTTP/HTTPS
sudo ufw allow 'Nginx Full'
```

### 2. 安全更新

```bash
# 安装自动更新
sudo apt install unattended-upgrades
sudo dpkg-reconfigure -plow unattended-upgrades
```

## 监控配置

### 1. PM2监控

```bash
# 查看应用状态
pm2 status

# 查看日志
pm2 logs

# 监控面板
pm2 monit
```

### 2. 系统监控

```bash
# 安装htop
sudo apt install htop

# 查看系统资源
htop
```

## 备份策略

### 1. 数据库备份

```bash
# 创建备份脚本
sudo nano backup.sh
```

```bash
#!/bin/bash
DATE=$(date +%Y-%m-%d)
mongodump --db myapp --out /var/backups/mongodb/$DATE
```

```bash
# 设置定时备份
sudo crontab -e
# 添加以下行
0 2 * * * /path/to/backup.sh
```

### 2. 代码备份

```bash
# 定期提交代码
git add .
git commit -m "Auto backup"
git push origin main
```

## 常见问题解决

### 1. 端口占用

```bash
# 查找占用端口的进程
sudo lsof -i :3000

# 终止进程
sudo kill -9 PID
```

### 2. 权限问题

```bash
# 修复文件权限
sudo chown -R $USER:$USER /var/www/myapp
```

### 3. 内存不足

```bash
# 在ecosystem.config.js中限制内存
max_memory_restart: '1G'
```

## 最佳实践

1. **定期更新**
   - 系统更新
   - 依赖更新
   - 安全补丁

2. **日志管理**
   - 定期清理日志
   - 设置日志轮转
   - 监控错误日志

3. **性能优化**
   - 启用Gzip压缩
   - 配置缓存
   - 优化数据库查询

通过以上步骤，你可以成功将Express应用部署到生产服务器上。记住，服务器部署是一个持续的过程，需要定期维护和优化。