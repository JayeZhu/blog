---
title: Electron modbus
date: 2025-10-27 15:41:05
permalink: /pages/067ab8/
categories:
  - 后端
tags:
  - Electron
  - Electron扩展
---
## 背景
客户端需要和机台对接，通过 smema 连接线完成信息交互，smema 连接线是 modbus 协议，因此需要使用 modbus 协议进行通信。

## 安装
```bash
npm install modbusjs
```

## 使用
```js
const modbus = require('modbusjs');

const ModbusTcpClient = modbus.ModbusTcpClient;

let interval; // 定时器
let state = 'wait'; // 状态
const CODE_IN = 0x0000; // 输入寄存器
const CODE_OUT = 0x0001; // 输出寄存器

const CMDS = {
  true: 1,
  false: 0,
}
  
// 定时获取要板信息
const readMsg = () => {
  interval = setInterval(async () => {
    try {
      const res: any = await client?.readHoldingRegisters(CODE_IN, CMDS.true);
      if (res?.result?.[0] === 1) {
        console.log('收到机台信息成功')
        state = 'wait';
        clearInterval(interval)
        handleMsg(res)
      }
    } catch (error) {
      console.error('收到机台信息失败: ', error);
    }
  }, 1000)
}

// 发送消息
const postMsg = async (code, wait?: number) => {
  client?.writeSingleRegister(code, cmds.true);
  setTimeout(async () => {
    client?.writeSingleRegister(code, cmds.false);
    readMsg();
  }, wait)
}

const handleMsg = async (res) => {
  // 数据操作
  postMsg(CODE_OUT, 1000)
}

// 定时器
const waitFn = (fn, wait) => {
}

// 连接
const connect = async (args) => {
  try {
    const { ip, port, param } = args;
    if (clients?.[line]) {
      clients[line]?.disconnectModbusClient();
      delete clients[line]
    }
    // 实例化
    const client = new ModbusTcpClient(ip, port, param);
    await client.connect();
    console.log('连接PLC成功')
    readMsg();
  } catch (error) {
    console.error('连接PLC失败', error)
  }
}

```

## 参考
- [modbusjs](https://github.com/razakj/modbusjs)