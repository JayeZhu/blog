---
title: Electron 文件监控
date: 2025-10-27 15:20:53
permalink: /pages/f2bd76/
categories:
  - 后端
tags:
  - Electron
  - Electron扩展
---
## 背景
客户端需要监控文件变更，文件是通过 Windows 主机进行文件共享，也就是 Samba 服务器。

## chokidar
Chokidar 是一个专为 Node.js 设计的高效文件系统监听库，它通过弥补 Node.js 原生 fs.watch和 fs.watchFileAPI 的不足，提供了更强大、更可靠的文件监控体验。下面是它的主要优点：

​🚀 跨平台稳定性与准确性​

修复了原生 API 在不同操作系统（尤其在 macOS）下行为不一致、报告事件不准确或遗漏事件的问题
。

​🎯 精准的事件处理​

通过优化减少了事件的冗余报告，能更准确地识别变化类型（如区分内容修改与重命名），并提供丰富的事件类型（add, change, unlink, addDir, unlinkDir等）
。

​💾 出色的性能表现​

通过优化监控机制（如在 macOS 上优先使用原生 fsevents）有效降低了 CPU 占用率，并支持递归监视整个目录树而无需复杂代码
。

​⚙️ 高度的可用性与灵活性​

提供简洁直观的 API 和多种实用配置选项（如 ignored忽略文件、ignoreInitial忽略初始扫描事件、awaitWriteFinish等待写入完成），并得到开源社区的积极维护和广泛应用验证（如 Webpack, Gulp, Vite, PM2 等）
。

## 使用
```bash
npm install chokidar
```

```ts
const chokidar = require('chokidar');
const fs = require('fs');
const path = require('path');
const watchPath = '***'; // 监控的文件夹路径
const CHOKIDAR_OPTIONS = {
  persistent: false, // 持久监控
  ignoreInitial: true, // 忽略初始化
  usePolling: false, // 关闭轮询
  depth: 0, // 监控深度, 0 代表只监控当前目录
  followSymlinks: false,
  ignorePermissionErrors: true
}
/**
 * followSymlinks: false
- 是否跟踪符号链接（软链接）
- 设置为 `false` 表示不跟踪符号链接指向的文件或目录
- 这有助于避免无限循环和不必要的监控，提高性能
 */

/**
 * ignorePermissionErrors: true
- 是否忽略权限错误
- 设置为 `true` 表示当遇到权限不足的文件或目录时，不会抛出错误
- 这可以防止监控因为权限问题而中断，提高监控的稳定性
 */

// 额外参数
const mergeParam = {
  ignored: /(^|[\/\\])\../, // 忽略点文件
}

// 创建实例
const watcher = chokidar.watch(watchPath, mergeParam);

const handleWatchReady = () => {
  console.log('Initial scan complete. Ready for changes');
};

const handleWatchError = (error: any) => {
  console.error('Error happened', error);
};

const handleWatchAddDir = (snPath: string, stats: any) => {
  console.log(`Directory ${snPath} has been added`);
  console.log(`stats: ${stats}`);
}

// 添加事件监听器
watcher.on('ready', handleWatchReady)
watcher.on('error', handleWatchError)
watcher.on('addDir', async (snPath: string, stats: any) => handleWatchAddDir(snPath, stats))

const stopWatch = () => {
  watcher && watcher.close();
}
```

## 注意事项
### 监控受限
一些老旧的windows系统可能存在监控受限的问题，比如 Windows XP 和 Windows 7，这些系统可能无法正确处理文件监控事件，导致监控功能失效。因此，建议在开发过程中，尽量使用较新的操作系统进行测试和部署。

### 文件权限
在监控文件时，如果遇到权限问题，可能会导致监控功能失效。因此，建议在开发过程中，确保应用程序具有足够的权限来访问和监控目标文件和目录。

### 文件事件延迟
在某些情况下，文件监控事件可能会出现延迟。这是由于操作系统和文件系统的限制，以及 Node.js 和 Electron 的内部实现。因此，如果需要实时监控文件变化，建议设置 usePolling 选项为 true，以启用轮询机制。

### 文件数目限制
在监控文件时，如果文件大小超过一定限制，可能会导致监控功能异常。