---
title: Electron打包和分发
date: 2025-10-20 15:12:48
permalink: /pages/0bed68/
categories:
  - 后端
tags:
  - Electron
  - Electron工程化
---
Electron 应用开发完成后，需要将其打包成各平台的原生应用程序，以便用户安装和使用。本文将详细介绍如何使用 electron-builder 和 electron-forge 等工具将应用打包成 Windows、macOS 和 Linux 平台的可执行文件。

## 准备工作

在开始打包之前，需要确保以下几点：

1. **完善应用信息**：在 `package.json` 中添加必要的应用信息
2. **准备应用图标**：为不同平台准备适当尺寸和格式的图标
3. **配置应用签名**：特别是对于 macOS 和 Windows 应用

```json
// package.json
{
  "name": "my-electron-app",
  "version": "1.0.0",
  "description": "我的Electron应用",
  "main": "main.js",
  "author": "您的姓名",
  "license": "MIT",
  "homepage": "https://your-website.com",
  "repository": {
    "type": "git",
    "url": "https://github.com/your-username/your-repo"
  }
}
```

## 使用 electron-builder 打包

electron-builder 是一个功能强大的 Electron 应用打包工具，支持多平台打包和自定义配置。

### 安装 electron-builder

```bash
npm install electron-builder --save-dev
```

### 配置 electron-builder

在 `package.json` 中添加 electron-builder 配置：

```json
{
  "build": {
    "appId": "com.example.myapp",
    "productName": "我的应用",
    "directories": {
      "output": "dist"
    },
    "files": [
      "main.js",
      "preload.js",
      "dist/**/*",
      "node_modules/**/*"
    ],
    "mac": {
      "category": "public.app-category.productivity",
      "icon": "assets/icon.icns",
      "hardenedRuntime": true,
      "gatekeeperAssess": false,
      "entitlements": "assets/entitlements.mac.plist",
      "entitlementsInherit": "assets/entitlements.mac.plist"
    },
    "win": {
      "target": "nsis",
      "icon": "assets/icon.ico"
    },
    "linux": {
      "target": "AppImage",
      "icon": "assets/icon.png",
      "category": "Office"
    },
    "nsis": {
      "oneClick": false,
      "allowToChangeInstallationDirectory": true
    }
  },
  "scripts": {
    "build": "electron-builder",
    "build:win": "electron-builder --win",
    "build:mac": "electron-builder --mac",
    "build:linux": "electron-builder --linux"
  }
}
```

### 打包命令

```bash
# 打包所有平台
npm run build

# 仅打包 Windows
npm run build:win

# 仅打包 macOS
npm run build:mac

# 仅打包 Linux
npm run build:linux
```

### 平台特定配置

#### Windows 打包

```json
{
  "build": {
    "win": {
      "target": [
        {
          "target": "nsis",
          "arch": ["x64", "ia32"]
        },
        {
          "target": "portable",
          "arch": ["x64"]
        }
      ],
      "icon": "assets/icon.ico",
      "requestedExecutionLevel": "asInvoker",
      "publisherName": "我的公司"
    },
    "nsis": {
      "oneClick": false,
      "allowToChangeInstallationDirectory": true,
      "createDesktopShortcut": true,
      "createStartMenuShortcut": true
    }
  }
}
```

#### macOS 打包

```json
{
  "build": {
    "mac": {
      "category": "public.app-category.productivity",
      "icon": "assets/icon.icns",
      "hardenedRuntime": true,
      "gatekeeperAssess": false,
      "entitlements": "assets/entitlements.mac.plist",
      "entitlementsInherit": "assets/entitlements.mac.plist",
      "target": [
        {
          "target": "dmg",
          "arch": ["x64", "arm64"]
        },
        {
          "target": "zip",
          "arch": ["x64", "arm64"]
        }
      ]
    },
    "dmg": {
      "title": "我的应用安装程序",
      "icon": "assets/volume-icon.icns",
      "background": "assets/dmg-background.png",
      "contents": [
        {
          "x": 130,
          "y": 220
        },
        {
          "x": 410,
          "y": 220,
          "type": "link",
          "path": "/Applications"
        }
      ]
    }
  }
}
```

#### Linux 打包

```json
{
  "build": {
    "linux": {
      "target": [
        {
          "target": "AppImage",
          "arch": ["x64"]
        },
        {
          "target": "deb",
          "arch": ["x64"]
        },
        {
          "target": "rpm",
          "arch": ["x64"]
        }
      ],
      "icon": "assets/icon.png",
      "category": "Office"
    }
  }
}
```

## 使用 electron-forge 打包

electron-forge 是另一个流行的 Electron 应用打包工具，它提供了一套完整的项目创建、开发和打包解决方案。

### 安装 electron-forge

```bash
# 全局安装
npm install -g electron-forge

# 或者在项目中安装
npm install --save-dev @electron-forge/cli
```

### 使用 electron-forge 创建项目

```bash
# 创建新项目
electron-forge init my-new-project

# 或者使用模板
electron-forge init my-new-project --template=webpack
```

### 配置 electron-forge

electron-forge 的配置通常在 `forge.config.js` 文件中：

```javascript
module.exports = {
  packagerConfig: {
    name: '我的应用',
    icon: './assets/icon',
    extraResource: [
      './assets'
    ]
  },
  rebuildConfig: {},
  makers: [
    {
      name: '@electron-forge/maker-squirrel',
      config: {
        name: 'my_electron_app'
      }
    },
    {
      name: '@electron-forge/maker-zip',
      platforms: ['darwin']
    },
    {
      name: '@electron-forge/maker-deb',
      config: {
        options: {
          maintainer: '您的姓名',
          homepage: 'https://your-website.com'
        }
      }
    },
    {
      name: '@electron-forge/maker-rpm',
      config: {
        options: {
          maintainer: '您的姓名',
          homepage: 'https://your-website.com'
        }
      }
    }
  ],
  plugins: [
    {
      name: '@electron-forge/plugin-auto-unpack-natives',
      config: {}
    }
  ]
};
```

### 打包命令

```bash
# 打包所有平台
electron-forge make

# 打包特定平台
electron-forge make --platform=win32
electron-forge make --platform=darwin
electron-forge make --platform=linux
```

## 应用签名

应用签名是分发应用程序的重要步骤，特别是对于 macOS 和 Windows 平台。

### macOS 应用签名

```bash
# 安装开发者证书后，使用 electron-builder 自动签名
electron-builder --mac --publish=never

# 或者手动签名
electron-builder --mac --identity="Developer ID Application: Your Name (TEAM_ID)"
```

### Windows 应用签名

```bash
# 使用 electron-builder 自动签名
electron-builder --win --publish=never

# 或者手动签名
electron-builder --win --certificateFile="path/to/certificate.p12" --certificatePassword="password"
```

## 自动更新

electron-builder 和 electron-forge 都支持自动更新功能，可以让应用程序自动检查和下载更新。

### 使用 electron-updater 实现自动更新

```bash
npm install electron-updater --save
```

```javascript
// main.js
const { app, dialog } = require('electron');
const { autoUpdater } = require('electron-updater');

// 检查更新
function checkForUpdates() {
  autoUpdater.checkForUpdatesAndNotify();
  
  autoUpdater.on('update-available', () => {
    dialog.showMessageBox({
      type: 'info',
      title: '应用更新',
      message: '新版本可用，正在下载...',
      buttons: ['确定']
    });
  });
  
  autoUpdater.on('update-downloaded', () => {
    dialog.showMessageBox({
      type: 'info',
      title: '应用更新',
      message: '更新已下载，应用将重启...',
      buttons: ['立即重启', '稍后重启']
    }).then((result) => {
      if (result.response === 0) {
        autoUpdater.quitAndInstall();
      }
    });
  });
}

app.whenReady().then(() => {
  // 检查更新
  checkForUpdates();
  
  // 创建窗口等...
});
```

## 发布与分发

### 设置更新服务器

```json
// package.json
{
  "build": {
    "publish": [
      {
        "provider": "github",
        "owner": "your-username",
        "repo": "your-repo"
      }
    ]
  }
}
```

### 使用 GitHub Releases 发布

```bash
# 发布到 GitHub
electron-builder --publish=always

# 或者只构建不上传
electron-builder --publish=never
```

### 使用私有服务器发布

```json
// package.json
{
  "build": {
    "publish": {
      "provider": "generic",
      "url": "https://update-server.com/updates"
    }
  }
}
```

## 最佳实践

1. **优化打包大小**：
   - 使用 `asar` 打包以减小文件体积
   - 排除不必要的文件和依赖
   - 使用 `webpack` 或 `rollup` 优化代码

2. **安全考虑**：
   - 对代码进行混淆和加密
   - 启用 `contextIsolation` 和 `nodeIntegration: false`
   - 验证更新包的完整性

3. **跨平台注意事项**：
   - 在目标平台上进行测试
   - 注意不同平台的文件路径差异
   - 处理不同平台的特定功能

4. **版本管理**：
   - 遵循语义化版本控制
   - 为每个平台设置适当的版本号
   - 记录更新日志

## 总结

Electron 应用打包与分发是开发过程中的最后一步，也是至关重要的一步。通过使用 electron-builder 或 electron-forge 等工具，可以轻松地将应用打包成各平台的原生应用程序，并实现自动更新功能。

在实际开发中，建议根据项目需求选择合适的打包工具，并遵循最佳实践，以确保应用的性能、安全性和用户体验。同时，定期更新打包工具和依赖，以获得最新的功能和安全修复。