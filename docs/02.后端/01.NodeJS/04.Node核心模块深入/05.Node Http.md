---
title: Node Http
date: 2025-10-15 11:42:14
permalink: /pages/980495/
categories:
  - 后端
tags:
  - NodeJS
  - Node核心模块深入
---
## 1. 创建基础HTTP服务器

### 1.1 最简单的HTTP服务器

```javascript
const http = require('http');

const server = http.createServer((req, res) => {
  res.statusCode = 200;
  res.setHeader('Content-Type', 'text/plain');
  res.end('Hello World!');
});

server.listen(3000, () => {
  console.log('服务器运行在 http://localhost:3000');
});
```

### 1.2 服务器配置选项

```javascript
const options = {
  host: 'localhost',
  port: 3000,
  keepAlive: true,
  keepAliveTimeout: 5000
};

const server = http.createServer(options, (req, res) => {
  // 处理请求
});
```

## 2. 解析HTTP请求

### 2.1 基本请求信息

```javascript
const server = http.createServer((req, res) => {
  console.log('请求方法:', req.method);
  console.log('请求URL:', req.url);
  console.log('请求头:', req.headers);
  
  res.end('Request received');
});
```

### 2.2 URL解析

```javascript
const { URL } = require('url');

const server = http.createServer((req, res) => {
  const url = new URL(req.url, `http://${req.headers.host}`);
  
  console.log('路径:', url.pathname);
  console.log('查询参数:', url.searchParams);
  
  res.end('URL parsed');
});
```

### 2.3 路由处理

```javascript
const routes = {
  '/': (req, res) => res.end('Home'),
  '/about': (req, res) => res.end('About'),
  '/api': (req, res) => res.end('API')
};

const server = http.createServer((req, res) => {
  console.log(req.method, req.url);
  
  if (routes[req.url]) {
    routes[req.url](req, res);
  } else {
    res.statusCode = 404;
    res.end('Not Found');
  }
});
```

## 3. 构建HTTP响应

### 3.1 基本响应设置

```javascript
const server = http.createServer((req, res) => {
  // 设置状态码
  res.statusCode = 200;
  
  // 设置响应头
  res.setHeader('Content-Type', 'application/json');
  res.setHeader('Cache-Control', 'no-cache');
  
  // 设置多个响应头
  res.writeHead(200, {
    'Content-Type': 'application/json',
    'X-Custom-Header': 'value'
  });
  
  // 发送响应
  res.end(JSON.stringify({ message: 'Success' }));
});
```

### 3.2 发送不同类型的内容

```javascript
const server = http.createServer((req, res) => {
  // HTML响应
  if (req.url === '/html') {
    res.setHeader('Content-Type', 'text/html');
    res.end('<h1>Hello HTML</h1>');
  }
  
  // JSON响应
  else if (req.url === '/json') {
    res.setHeader('Content-Type', 'application/json');
    res.end(JSON.stringify({ message: 'Hello JSON' }));
  }
  
  // 文件下载
  else if (req.url === '/download') {
    res.setHeader('Content-Disposition', 'attachment; filename="file.txt"');
    res.end('File content');
  }
});
```

### 3.3 状态码处理

```javascript
const server = http.createServer((req, res) => {
  // 重定向
  if (req.url === '/old-url') {
    res.statusCode = 301;
    res.setHeader('Location', '/new-url');
    res.end();
  }
  
  // 客户端错误
  else if (req.url === '/bad-request') {
    res.statusCode = 400;
    res.end('Bad Request');
  }
  
  // 服务器错误
  else if (req.url === '/internal-error') {
    res.statusCode = 500;
    res.end('Internal Server Error');
  }
});
```

## 4. 处理请求体数据

### 4.1 处理POST数据

```javascript
const server = http.createServer((req, res) => {
  if (req.method === 'POST') {
    let body = '';
    
    // 接收数据块
    req.on('data', chunk => {
      body += chunk.toString();
    });
    
    // 接收完成
    req.on('end', () => {
      try {
        const data = JSON.parse(body);
        res.end(JSON.stringify({ received: data }));
      } catch (err) {
        res.statusCode = 400;
        res.end('Invalid JSON');
      }
    });
  }
});
```

### 4.2 处理文件上传

```javascript
const fs = require('fs');
const path = require('path');

const server = http.createServer((req, res) => {
  if (req.method === 'POST' && req.url === '/upload') {
    const filePath = path.join(__dirname, 'upload.txt');
    const writeStream = fs.createWriteStream(filePath);
    
    req.pipe(writeStream);
    
    writeStream.on('finish', () => {
      res.end('File uploaded');
    });
    
    writeStream.on('error', (err) => {
      res.statusCode = 500;
      res.end('Upload failed');
    });
  }
});
```

## 5. HTTP客户端请求

### 5.1 基本GET请求

```javascript
const http = require('http');

const options = {
  hostname: 'example.com',
  port: 80,
  path: '/api/data',
  method: 'GET'
};

const req = http.request(options, (res) => {
  let data = '';
  
  res.on('data', (chunk) => {
    data += chunk;
  });
  
  res.on('end', () => {
    console.log('响应:', data);
  });
});

req.on('error', (err) => {
  console.error('请求错误:', err);
});

req.end();
```

### 5.2 POST请求发送数据

```javascript
const postData = JSON.stringify({
  message: 'Hello World'
});

const options = {
  hostname: 'example.com',
  port: 80,
  path: '/api/submit',
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Content-Length': Buffer.byteLength(postData)
  }
};

const req = http.request(options, (res) => {
  console.log('状态码:', res.statusCode);
  
  res.on('data', (chunk) => {
    console.log('响应:', chunk);
  });
});

req.on('error', (err) => {
  console.error('请求错误:', err);
});

req.write(postData);
req.end();
```

### 5.3 HTTPS请求

```javascript
const https = require('https');

const options = {
  hostname: 'api.example.com',
  port: 443,
  path: '/secure/data',
  method: 'GET'
};

const req = https.request(options, (res) => {
  let data = '';
  
  res.on('data', (chunk) => {
    data += chunk;
  });
  
  res.on('end', () => {
    console.log('安全响应:', data);
  });
});

req.end();
```

## 6. 实际应用示例

### 6.1 REST API服务器

```javascript
const server = http.createServer((req, res) => {
  const url = new URL(req.url, `http://${req.headers.host}`);
  
  // 设置响应头
  res.setHeader('Content-Type', 'application/json');
  
  // GET请求
  if (req.method === 'GET' && url.pathname === '/api/users') {
    res.end(JSON.stringify([
      { id: 1, name: 'John' },
      { id: 2, name: 'Jane' }
    ]));
  }
  
  // POST请求
  else if (req.method === 'POST' && url.pathname === '/api/users') {
    let body = '';
    req.on('data', chunk => body += chunk);
    req.on('end', () => {
      const user = JSON.parse(body);
      res.statusCode = 201;
      res.end(JSON.stringify({ id: 3, ...user }));
    });
  }
  
  // 其他情况
  else {
    res.statusCode = 404;
    res.end(JSON.stringify({ error: 'Not Found' }));
  }
});
```

### 6.2 代理服务器

```javascript
const server = http.createServer((req, res) => {
  const options = {
    hostname: 'target-api.com',
    port: 80,
    path: req.url,
    method: req.method,
    headers: req.headers
  };
  
  const proxy = http.request(options, (targetRes) => {
    res.writeHead(targetRes.statusCode, targetRes.headers);
    targetRes.pipe(res);
  });
  
  req.pipe(proxy);
  
  proxy.on('error', (err) => {
    res.statusCode = 502;
    res.end('Bad Gateway');
  });
});
```

### 6.3 静态文件服务器

```javascript
const fs = require('fs');
const path = require('path');

const server = http.createServer((req, res) => {
  const filePath = path.join(__dirname, 'public', req.url);
  const ext = path.extname(filePath);
  
  // 设置Content-Type
  const contentTypes = {
    '.html': 'text/html',
    '.js': 'text/javascript',
    '.css': 'text/css',
    '.json': 'application/json'
  };
  
  res.setHeader('Content-Type', contentTypes[ext] || 'text/plain');
  
  // 读取文件
  const fileStream = fs.createReadStream(filePath);
  
  fileStream.on('open', () => {
    fileStream.pipe(res);
  });
  
  fileStream.on('error', () => {
    res.statusCode = 404;
    res.end('File not found');
  });
});
```

## 7. 安全考虑

### 7.1 CORS处理

```javascript
const server = http.createServer((req, res) => {
  // 设置CORS头
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
  
  // 处理预检请求
  if (req.method === 'OPTIONS') {
    res.statusCode = 200;
    res.end();
    return;
  }
  
  // 正常请求处理
  // ...
});
```

### 7.2 速率限制

```javascript
const rateLimit = new Map();

const server = http.createServer((req, res) => {
  const client = req.socket.remoteAddress;
  const timestamp = Date.now();
  
  // 清理过期记录
  for (const [ip, requests] of rateLimit) {
    rateLimit.set(ip, requests.filter(t => timestamp - t < 60000));
    if (rateLimit.get(ip).length === 0) {
      rateLimit.delete(ip);
    }
  }
  
  // 检查速率
  if (!rateLimit.has(client)) {
    rateLimit.set(client, []);
  }
  
  const requests = rateLimit.get(client);
  if (requests.length >= 100) {
    res.statusCode = 429;
    res.end('Too Many Requests');
    return;
  }
  
  requests.push(timestamp);
  // 正常处理请求
});
```

## 8. 最佳实践

1. **错误处理**
   - 始终处理可能的错误
   - 提供有意义的错误信息
   - 记录错误日志

2. **性能优化**
   - 使用流处理大文件
   - 设置适当的超时
   - 实现响应压缩

3. **安全性**
   - 验证输入数据
   - 实现速率限制
   - 设置安全头

4. **代码组织**
   - 分离路由逻辑
   - 使用中间件
   - 保持代码模块化

## 9. 调试技巧

```javascript
// 请求日志中间件
function logRequest(req, res, next) {
  console.log(`${new Date().toISOString()} ${req.method} ${req.url}`);
  next();
}

// 错误处理中间件
function handleError(err, req, res, next) {
  console.error(err.stack);
  res.statusCode = 500;
  res.end('Internal Server Error');
}

// 在服务器中使用
const server = http.createServer((req, res) => {
  try {
    logRequest(req, res, () => {
      // 处理请求
    });
  } catch (err) {
    handleError(err, req, res);
  }
});
```

## 10. 总结

Node.js 的 HTTP 模块提供了创建服务器和客户端的基础功能：

1. **服务器创建**
   - 可以创建基础的HTTP服务器
   - 支持HTTPS
   - 可配置各种选项

2. **请求处理**
   - 可以解析请求方法和URL
   - 支持请求体数据处理
   - 可以处理文件上传

3. **响应构建**
   - 支持设置状态码和头信息
   - 可以发送各种类型的内容
   - 支持流式响应

4. **客户端请求**
   - 可以发起HTTP/HTTPS请求
   - 支持各种请求方法
   - 可以发送和接收数据

使用这些功能可以构建出完整的HTTP服务。记住要注意安全性、性能优化和错误处理。