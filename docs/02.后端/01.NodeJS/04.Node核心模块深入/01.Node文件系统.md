---
title: Node文件系统
date: 2025-10-15 10:18:24
permalink: /pages/aae26f/
categories:
  - 后端
tags:
  - NodeJS
  - Node核心模块深入
---
## 1. 同步/异步读写

### 1.1 异步文件操作

#### 异步读取文件
```javascript
const fs = require('fs');

// 异步读取 - 回调方式
fs.readFile('example.txt', 'utf8', (err, data) => {
  if (err) throw err;
  console.log(data);
});

// 异步读取 - Promise方式
const fsPromises = require('fs').promises;
async function readFile() {
  try {
    const data = await fsPromises.readFile('example.txt', 'utf8');
    console.log(data);
  } catch (err) {
    console.error(err);
  }
}
```

#### 异步写入文件
```javascript
// 异步写入 - 回调方式
fs.writeFile('example.txt', 'Hello World', 'utf8', (err) => {
  if (err) throw err;
  console.log('文件已保存');
});

// 异步写入 - Promise方式
async function writeFile() {
  try {
    await fsPromises.writeFile('example.txt', 'Hello World', 'utf8');
    console.log('文件已保存');
  } catch (err) {
    console.error(err);
  }
}
```

### 1.2 同步文件操作

#### 同步读取文件
```javascript
const fs = require('fs');

try {
  const data = fs.readFileSync('example.txt', 'utf8');
  console.log(data);
} catch (err) {
  console.error(err);
}
```

#### 同步写入文件
```javascript
try {
  fs.writeFileSync('example.txt', 'Hello World', 'utf8');
  console.log('文件已保存');
} catch (err) {
  console.error(err);
}
```

### 1.3 流式文件操作

#### 读取流
```javascript
const fs = require('fs');

const readStream = fs.createReadStream('example.txt', 'utf8');

readStream.on('data', (chunk) => {
  console.log(chunk);
});

readStream.on('end', () => {
  console.log('读取完成');
});

readStream.on('error', (err) => {
  console.error(err);
});
```

#### 写入流
```javascript
const writeStream = fs.createWriteStream('example.txt', 'utf8');

writeStream.write('Hello');
writeStream.write(' World');
writeStream.end();

writeStream.on('finish', () => {
  console.log('写入完成');
});
```

## 2. 文件信息

### 2.1 获取文件状态
```javascript
const fs = require('fs');

// 异步获取文件状态
fs.stat('example.txt', (err, stats) => {
  if (err) throw err;
  console.log(stats);
});

// 同步获取文件状态
try {
  const stats = fs.statSync('example.txt');
  console.log(stats);
} catch (err) {
  console.error(err);
}
```

### 2.2 文件信息属性
```javascript
fs.stat('example.txt', (err, stats) => {
  if (err) throw err;
  
  console.log('是否为文件:', stats.isFile());
  console.log('是否为目录:', stats.isDirectory());
  console.log('文件大小:', stats.size);
  console.log('创建时间:', stats.birthtime);
  console.log('修改时间:', stats.mtime);
  console.log('访问时间:', stats.atime);
});
```

## 3. 目录操作

### 3.1 创建目录
```javascript
// 异步创建目录
fs.mkdir('newDir', { recursive: true }, (err) => {
  if (err) throw err;
  console.log('目录创建成功');
});

// 同步创建目录
try {
  fs.mkdirSync('newDir', { recursive: true });
  console.log('目录创建成功');
} catch (err) {
  console.error(err);
}
```

### 3.2 读取目录
```javascript
// 异步读取目录
fs.readdir('exampleDir', (err, files) => {
  if (err) throw err;
  console.log(files);
});

// 同步读取目录
try {
  const files = fs.readdirSync('exampleDir');
  console.log(files);
} catch (err) {
  console.error(err);
}
```

### 3.3 删除目录
```javascript
// 异步删除空目录
fs.rmdir('emptyDir', (err) => {
  if (err) throw err;
  console.log('目录删除成功');
});

// 异步递归删除目录
fs.rm('dir', { recursive: true }, (err) => {
  if (err) throw err;
  console.log('目录删除成功');
});
```

## 4. fs/promises API

### 4.1 基本文件操作
```javascript
const fs = require('fs').promises;

// 读取文件
async function readFile() {
  try {
    const data = await fs.readFile('example.txt', 'utf8');
    return data;
  } catch (err) {
    console.error(err);
  }
}

// 写入文件
async function writeFile() {
  try {
    await fs.writeFile('example.txt', 'Hello World', 'utf8');
    console.log('写入成功');
  } catch (err) {
    console.error(err);
  }
}
```

### 4.2 目录操作
```javascript
// 创建目录
async function createDir() {
  try {
    await fs.mkdir('newDir', { recursive: true });
    console.log('目录创建成功');
  } catch (err) {
    console.error(err);
  }
}

// 读取目录
async function readDir() {
  try {
    const files = await fs.readdir('exampleDir');
    console.log(files);
  } catch (err) {
    console.error(err);
  }
}
```

### 4.3 文件信息操作
```javascript
// 获取文件状态
async function getFileStats() {
  try {
    const stats = await fs.stat('example.txt');
    console.log(stats);
    return stats;
  } catch (err) {
    console.error(err);
  }
}

// 检查文件是否存在
async function checkFileExists() {
  try {
    await fs.access('example.txt');
    console.log('文件存在');
  } catch (err) {
    console.log('文件不存在');
  }
}
```

## 5. 实用示例

### 5.1 复制文件
```javascript
async function copyFile(source, destination) {
  try {
    await fs.copyFile(source, destination);
    console.log('文件复制成功');
  } catch (err) {
    console.error(err);
  }
}
```

### 5.2 递归读取目录
```javascript
async function readDirRecursive(dir) {
  try {
    const files = await fs.readdir(dir);
    const result = [];
    
    for (const file of files) {
      const path = `${dir}/${file}`;
      const stats = await fs.stat(path);
      
      if (stats.isDirectory()) {
        result.push(...await readDirRecursive(path));
      } else {
        result.push(path);
      }
    }
    
    return result;
  } catch (err) {
    console.error(err);
  }
}
```

### 5.3 监视文件变化
```javascript
const fs = require('fs');

fs.watch('example.txt', (eventType, filename) => {
  console.log(`事件类型: ${eventType}`);
  if (filename) {
    console.log(`文件名: ${filename}`);
  }
});
```

## 6. 最佳实践

1. **错误处理**
   - 始终进行错误检查
   - 使用 try-catch 处理同步操作
   - 使用回调或 catch 处理异步操作

2. **性能考虑**
   - 大文件操作使用流
   - 批量操作使用 Promise.all
   - 避免同步操作阻塞事件循环

3. **安全性**
   - 验证文件路径
   - 设置适当的文件权限
   - 处理文件边界情况

4. **路径处理**
   - 使用 path 模块处理路径
   - 注意跨平台兼容性
   - 规范化路径格式

## 7. 注意事项

1. **文件描述符**
   - 及时关闭文件描述符
   - 注意系统限制
   - 使用流处理大文件

2. **并发控制**
   - 控制并发文件操作数量
   - 使用队列管理文件操作
   - 避免资源竞争

3. **内存管理**
   - 大文件使用流处理
   - 及时释放资源
   - 监控内存使用

4. **错误恢复**
   - 实现重试机制
   - 处理部分失败
   - 提供回滚方案

这个指南涵盖了 Node.js 文件系统的主要功能和使用方法，可以帮助你更好地处理文件系统相关的操作。记住要根据具体场景选择合适的 API，并始终注意错误处理和性能优化。