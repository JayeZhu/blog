---
title: Node模块化系统
date: 2025-10-13 16:52:02
permalink: /pages/805714/
categories:
  - 后端
tags:
  - NodeJS
  - Node模块
---
## CommonJS
CommonJS 是 Node.js 中的模块化规范，它定义了模块的导入和导出规则。

### 导出
使用 `module.exports` 或 `exports` 对象来导出模块的变量、函数或类。

#### module.exports
```javascript
// 导出变量
module.exports = {
  name: 'John',
  age: 30
};

// 导出函数
module.exports = function() {
  console.log('Hello, world!');
};

// 导出类
module.exports = class Person {
  constructor(name, age) {
    this.name = name;
    this.age = age;
  }
};
```

#### exports
```javascript
// 导出变量
exports.name = 'John';
exports.age = 30;

// 导出函数
exports.sayHello = function() {
  console.log('Hello, world!');
};

// 导出类
exports.Person = class {
  constructor(name, age) {
    this.name = name;
    this.age = age;
  }
};
```

### 导入
使用 `require` 函数来导入模块。

#### require
```javascript
// 导入模块
const module = require('./module.js');

// 使用模块中的变量、函数或类
console.log(module.name); // John
```

#### 导入顺序
- **核心模块**：优先加载Node.js内置模块
- **文件模块**：如果路径以./或../开头，按路径查找
- **目录模块**：如果路径是目录，查找package.json或index.js
- **node_modules**：从node_modules目录查找

### 模块加载机制
- 缓存优先：检查模块是否已加载
- 核心模块：检查是否是内置模块
- 路径分析：根据路径类型进行查找
- 文件扩展名补全：尝试添加.js、.json、.node扩展名
- 目录包查找：查找package.json或index.js

### 模块缓存机制
- 每个模块只加载一次，后续引用直接从缓存中获取
- 缓存对象存储在 `Module._cache` 中

### 模块作用域
- 模块内部变量和函数对外部不可见
- 避免全局变量污染

### 模块循环依赖
- 模块循环依赖时，会加载模块的当前状态，而不是最终状态
- 可以使用 `require.cache` 查看模块缓存

## ES6 模块
ES6引入了新的模块系统，使用import和export关键字。

### 导出
使用 `export` 关键字来导出模块的变量、函数或类。

```javascript
// 导出变量
export const name = 'John';
export const age = 30;

// 导出函数
export function sayHello() {
  console.log('Hello, world!');
};

// 导出类
export class Person {
  constructor(name, age) {
    this.name = name;
    this.age = age;
  }
}
```

### 导入
使用 `import` 关键字来导入模块。

```javascript
// 导入模块
import { name, age } from './module.js';

// 使用模块中的变量、函数或类
console.log(name); // John
```

### 模块加载机制
- 模块加载是异步的，不会阻塞代码执行
- 模块加载完成后，会执行模块代码

### 模块缓存机制
- 每个模块只加载一次，后续引用直接从缓存中获取

## CommonJS vs ES6 模块
| 特性 | CommonJS | ES6模块 |
|------|----------|---------|
| 加载方式 | 同步加载，运行时 | 异步加载，编译时 |
| 导出方式 | module.exports/exports | export/export default |
| 导入方式 | require() | import |
| 顶层作用域 | 非严格模式 | 严格模式 |
| 动态导入 | 原生支持 | 使用import()函数 |